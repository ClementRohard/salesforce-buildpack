#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

### Configure directories

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
SALESFORCE_DIR=$BUILD_DIR/.salesforce

### Load dependencies

source $BP_DIR/lib/common.sh
source $BP_DIR/lib/node.sh

### Compile

status "Exporting config vars to environment"
export_env_dir

install_nodejs $SALESFORCE_DIR

node --version
npm --version

exit 0

#echo "BUILD_DIR: $BUILD_DIR"
#echo "SOURCE_VERSION: $SOURCE_VERSION"
#echo "RECEIVE_DATA: $RECEIVE_DATA"

export BUILD_DIR=$1

DRIVER_VERSION="1.0.0-DEMO-6"
BUILD_TOOL_URL=https://github.com/forcedotcom/force-com-buildpack/releases/download/$DRIVER_VERSION/driver-prototype.jar
JAR_NAME=appcloud-client.jar
SALESFORCE_DIR=$BUILD_DIR/.salesforce
BUILD_TOOL_DEST=$SALESFORCE_DIR/lib
BUILD_TOOL_JAR=$BUILD_TOOL_DEST/$JAR_NAME

mkdir -p $BUILD_TOOL_DEST
status "Downloading Force.com test client version $DRIVER_VERSION"
wget -q $BUILD_TOOL_URL -O $BUILD_TOOL_JAR

status "Setting up Force.com"

cat > $SALESFORCE_DIR/deploy << EOF
if [[ \$SALESFORCE_URL ]]
then
  echo "Deploying Force.com application" | indent
  #java -cp .salesforce/lib/$JAR_NAME Main
else
  error "Force.com deployment failed because SALESFORCE_URL is not configured"
  exit 1
fi
EOF

chmod +x $SALESFORCE_DIR/deploy

echo "Configure your application to invoke .salesforce/deploy in your release phase script." | indent
