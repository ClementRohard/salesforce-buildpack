#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

START_TIME=$SECONDS

### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

### Configure directories
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

### Configure salesforce directories
SALESFORCE_DIR_NAME=".salesforce"
SALESFORCE_DIR=$BUILD_DIR/$SALESFORCE_DIR_NAME
SALESFORCE_CACHE_DIR=$CACHE_DIR/$SALESFORCE_DIR_NAME

### Load dependencies
source $BP_DIR/lib/common.sh
source $BP_DIR/lib/node.sh
source $BP_DIR/lib/libs.sh

echo ""
highlight "Welcome to Salesforce Buildpack!!"
echo ""

# present of files below determine how we handle deployment
if [ -f $1/salesforce/src/package.xml ]; then
    log "Found Force.com Metadata API project"
    export SALESFORCE_WORKSPACE=false
elif [ -f $1/config.json ]; then
    log "Found Force.com workspace project"
    export SALESFORCE_WORKSPACE=true
fi

### Compile
status "Exporting config vars to environment"
export_env_dir

mkdir -p $SALESFORCE_DIR
export SALESFORCE_DIR=$SALESFORCE_DIR

# REVIEWME: probably can remove if we use nodejs buildpack
install_nodejs $SALESFORCE_CACHE_DIR
# Put node in build dir since the cache is not available at time of deploy
cp -a $SALESFORCE_CACHE_DIR/node $SALESFORCE_DIR/node
export PATH="$SALESFORCE_DIR/node/bin":$PATH

# set defaults for optional config vars
if [[ ! -v SALESFORCE_BYOO ]]; then
   export SALESFORCE_BYOO="false"
fi

if [[ ! -v SALESFORCE_BUILDPACK_VERBOSE ]]; then
   export SALESFORCE_BUILDPACK_VERBOSE="false"
fi

# FIXME: workaround for HEROKU_APP_NAME not provided by staging app
if [[ ! -v HEROKU_APP_NAME ]]; then
   export HEROKU_APP_NAME="App Name Unknown"
fi

status "Generating release phase deploy script to $SALESFORCE_DIR_NAME/deploy"
cp -R $BP_DIR/lib/* $SALESFORCE_DIR/
cp $BP_DIR/package.json $SALESFORCE_DIR/package.json
# write script triggering node-based deployment to-be-invoked bin/release
echo "export SALESFORCE_WORKSPACE=$SALESFORCE_WORKSPACE" > $SALESFORCE_DIR/deploy
echo "export SALESFORCE_BYOO=$SALESFORCE_BYOO" >> $SALESFORCE_DIR/deploy
echo "export SALESFORCE_BUILDPACK_VERBOSE=$SALESFORCE_BUILDPACK_VERBOSE" >> $SALESFORCE_DIR/deploy
# relative dir as BUILD_DIR not same in release phase
echo "export SALESFORCE_DIR=$SALESFORCE_DIR_NAME" >> $SALESFORCE_DIR/deploy
# not needed for release, but adding until release is broken out from force.js
echo "export HEROKU_APP_NAME=$HEROKU_APP_NAME" >> $SALESFORCE_DIR/deploy
echo "$SALESFORCE_DIR_NAME/node/bin/node $SALESFORCE_DIR_NAME/force.js release" >> $SALESFORCE_DIR/deploy
chmod +x $SALESFORCE_DIR/deploy
if [ "$SALESFORCE_BUILDPACK_VERBOSE" == "true" ]; then
    debug "Script: `cat $SALESFORCE_DIR/deploy`"
fi

status "Installing node modules..."
cd $SALESFORCE_DIR
npm install | indent

# double-check that node is installed
if [ ! -f $SALESFORCE_DIR/node/bin/node ]; then
    error "! Node not found at $SALESFORCE_DIR/node/bin/node"
fi

# install secret tool used by appcloud
# FIXME: disabled for now
#install_libsecret

# delegate actual source deployment to node script
status "Invoking $SALESFORCE_DIR/force.js compile phase..."
$SALESFORCE_DIR/node/bin/node $SALESFORCE_DIR/force.js compile

DEPLOY_MSG="To DEPLOY source to org, configure your application to invoke '$SALESFORCE_DIR_NAME/deploy' in your release phase script."

HEROKU_PATH=/app/vendor/heroku-toolbelt/bin
ls $HEROKU_PATH
export PATH=$PATH:"$HEROKU_PATH"
log "PATH=$PATH"
HEROKU_CLIENT="$HEROKU_PATH/heroku"
if type "$HEROKU_CLIENT" &> /dev/null; then
    log "Found Heroku CLI at $heroku_client"
    status "Installing AppCloud Plugin..."
    # FIXME: change to salesforce-alm
    $heroku_client plugins:install salesforce-alm-buildpack-dev
    $heroku_client plugins
    highlight "$DEPLOY_MSG"
    highlight "To TEST, configure your application to invoke Heroku CLI AppCloud Plugin test commands (force:apex:test or force:test) in the test section of your app.json."
    highlight "To IMPORT DATA into the org, configure your application to invoke Heroku CLI AppCloud Plugin data command (force:data:import) in your release phase script."
else
    log "Heroku CLI not found."
    log "To use AppCloud Plugin commands in test and release phases, add 'heroku-buildpack-toolbelt' buildpack to app."

    status "Generating test phase script to $SALESFORCE_DIR_NAME/test"
    # write script to-be-invoked via test phase per app.json
    echo "export SALESFORCE_WORKSPACE=$SALESFORCE_WORKSPACE" > $SALESFORCE_DIR/test
    echo "export SALESFORCE_BUILDPACK_VERBOSE=$SALESFORCE_BUILDPACK_VERBOSE" >> $SALESFORCE_DIR/test
    # relative dir as BUILD_DIR not same in test phase
    echo "export SALESFORCE_DIR=$SALESFORCE_DIR_NAME" >> $SALESFORCE_DIR/test
    # not needed for release, but adding until release is broken out from force.js
    echo "export HEROKU_APP_NAME=$HEROKU_APP_NAME" >> $SALESFORCE_DIR/test
    echo "$SALESFORCE_DIR_NAME/node/bin/node $SALESFORCE_DIR_NAME/force.js test" >> $SALESFORCE_DIR/test
    chmod +x $SALESFORCE_DIR/test
    if [ "$SALESFORCE_BUILDPACK_VERBOSE" == "true" ]; then
        debug "Script: `cat $SALESFORCE_DIR/test`"
    fi

    echo ""
    highlight "$DEPLOY_MSG"
    highlight "To run all Apex tests, configure your application to invoke '$SALESFORCE_DIR_NAME/test' via 'test' in your app.json."
fi

highlight "DONE!  Completed in $(($SECONDS - $START_TIME))s"
